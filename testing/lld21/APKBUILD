# Contributor: Eric Molitor <eric@molitor.org>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Contributor: Rasmus Thomsen <oss@cogitri.dev>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgver=21.1.0_rc2
pkgrel=0
#_llvmver=${pkgver%%.*}
_llvmver=21
_prevllvmver=$((_llvmver - 1))
pkgname=lld$_llvmver
pkgdesc="The LLVM Linker"
url="https://llvm.org/"
arch="all"
license="Apache-2.0"
depends_dev="$pkgname=$pkgver-r$pkgrel"
makedepends="
	clang$_llvmver
	cmake
	compiler-rt
	libedit-dev
	libxml2-dev
	llvm$_llvmver-dev
	llvm$_llvmver-gtest
	llvm$_llvmver-static
	llvm$_llvmver-test-utils
	llvm-libunwind-dev
	patchelf
	samurai
	scudo-malloc
	zlib-dev
	"
checkdepends="gtest-dev bash llvm$_llvmver-test-utils"
subpackages="$pkgname-dbg $pkgname-libs $pkgname-dev $pkgname-doc"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-${pkgver//_/-}/lld-${pkgver//_/-}.src.tar.xz
	https://github.com/llvm/llvm-project/releases/download/llvmorg-${pkgver//_/-}/cmake-${pkgver//_/-}.src.tar.xz
	https://github.com/llvm/llvm-project/releases/download/llvmorg-${pkgver//_/-}/llvm-${pkgver//_/-}.src.tar.xz
	big-endian.patch
	"
builddir="$srcdir/lld-${pkgver//_/-}.src"

# whether this is the default lld version (keep in sync with llvm)
_default_lld="no"

if [ "$_default_lld" = yes ]; then
	provides="lld=$pkgver-r$pkgrel"
	replaces="lld"

	dev() {
		default_dev
		provides="lld-dev=$pkgver-r$pkgrel"
		replaces="lld-dev"
	}
fi

replaces="lld$_prevllvmver"

prepare() {
	default_prepare
	mv "$srcdir"/cmake-${pkgver//_/-}.src "$srcdir"/cmake
	mv "$srcdir"/llvm-${pkgver//_/-}.src "$srcdir"/llvm
}

build() {
	CFLAGS="$CFLAGS -O2 -DNDEBUG -g1" \
	CXXFLAGS="$CXXFLAGS -O2 -DNDEBUG -g1" \
	CC=clang-$_llvmver CXX=clang++-$_llvmver \
	cmake -B build -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DBUILD_SHARED_LIBS=ON \
		-DLLVM_INCLUDE_TESTS="$(want_check && echo ON || echo OFF)" \
		-DLLVM_EXTERNAL_LIT=/usr/lib/llvm$_llvmver/bin/lit \
		-DLLD_BUILT_STANDALONE=ON \
		-DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS -Wl,-z,stack-size=2097152" \
		-DLLVM_VERSION_SUFFIX="_${pkgver#*_}"
	cmake --build build
}

check() {
	ninja -C build check-lld
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	install -Dm644 docs/ld.lld.1 -t "$pkgdir"/usr/share/man/man1/

	# we have the scudo allocator available, so link lld to it to
	# significantly improve performance, especially in LTO contexts
	patchelf --add-needed libscudo.so "$pkgdir"/usr/bin/lld
}

doc() {
	default_doc
	replaces="lld-doc lld$_prevllvmver-doc"
}

sha512sums="
1410b3948fe3515b91a5721223c35abd22480b0de9874c7fc5afb26bd8a014013016b16a08ef0f32fc134bf22de439da9b16f46c7f725f6fbb70d4eb8bb560f0  lld-21.1.0-rc2.src.tar.xz
2d37b711f921f5596f0e8674e30223194c295300a5c0e2fe5b8f0c14bca7dd18d35777a3f34e363b211ed1faeefdd2bd223d88b663143211317eb541f754d218  cmake-21.1.0-rc2.src.tar.xz
5823d69248db7768af3031defda1596675875d16b34503f7c6171b4b8d3f44211ad233f2597dadb21c5c8e147fcef6108c8bc6b9e8b59cddcfa7a6aae777c1d3  llvm-21.1.0-rc2.src.tar.xz
722904b29a356540bdf52f2183c57f88b285043579fc151ffb887bfd52e2f845d907b5b51540ffec79dc91eec160db5b3d34add8068ac98300dc33a9bc65b68e  big-endian.patch
"
