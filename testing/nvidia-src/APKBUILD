# Contributor: Dominika Liberda <ja@sdomi.pl>
# Maintainer: Dominika Liberda <ja@sdomi.pl>
pkgname=nvidia-src
pkgver=575.64.03
pkgrel=0
pkgdesc="NVIDIA Linux open GPU kernel module source (sources, AKMS)"
url="https://github.com/NVIDIA/open-gpu-kernel-modules"
# x86_64/aarch64 only
arch="noarch !riscv64 !s390x !armhf !armv7 !x86 !ppc64le"
license="MIT AND GPL-2.0-or-later"
depends="akms"
source="$pkgname-$pkgver.tar.gz::https://github.com/NVIDIA/open-gpu-kernel-modules/archive/refs/tags/$pkgver.tar.gz"
builddir="$srcdir/open-gpu-kernel-modules-$pkgver"
options="!check" # no tests

package() {
	mkdir -p "$pkgdir"/usr/src
	cp -r "$builddir" "$pkgdir"/usr/src/nvidia-$pkgver

	cat > "$pkgdir"/usr/src/nvidia-$pkgver/AKMBUILD <<-EOF
	modname=nvidia
	modver=$pkgver-r$pkgrel
	makedepends="linux-headers"
	built_modules="kernel-open/nvidia.ko \
		kernel-open/nvidia-drm.ko \
		kernel-open/nvidia-modeset.ko \
		kernel-open/nvidia-uvm.ko \
		kernel-open/nvidia-peermem.ko \
		"

	build() {
		make modules \$MAKEFLAGS
	}
	EOF
}

sha512sums="
43651b3f2f646c2f3b395c2790025d1f39765e8dfe6ccf2c3d4e8a7a8f75827f50b7ef45d05c890c24f7e032a0aaf02583943b3c62191fcdb34d424abb3610c2  nvidia-src-575.64.03.tar.gz
"
