# Maintainer: Lauri Tirkkonen <lauri@hacktheplanet.fi>
pkgname=yaml-language-server
pkgver=1.19.0
pkgrel=0
pkgdesc="Language Server for YAML Files"
url="https://github.com/redhat-developer/yaml-language-server"
arch="noarch"
license="MIT"
depends="nodejs"
makedepends="yarn esbuild jq"
source="https://github.com/redhat-developer/yaml-language-server/archive/refs/tags/$pkgver/yaml-language-server-$pkgver.tar.gz
yaml-language-server"
subpackages="$pkgname-doc"

_get_yarn_deps() {
	local pkg_with_ver="$(yarn list -s --pattern "$1" | cut -d" " -f2)"
	yarn info --json "$pkg_with_ver" dependencies | jq -r '.data|keys[]'
}

build() {
	yarn install --frozen-lockfile

	# vscode-json-languageservice can't be bundled:
	# https://github.com/microsoft/vscode-json-languageservice/issues/200
	# work around by making it and its direct dependencies external.
	local extpkgs="vscode-json-languageservice $(_get_yarn_deps vscode-json-languageservice)"
	local extarg=
	for p in $extpkgs; do
		extarg="$extarg --external:$p"
	done

	yarn compile
	esbuild out/server/src/server.js $extarg --platform=node --bundle --outdir=dist/
}

check() {
	yarn test
}

package() {
	local moddir="$pkgdir"/usr/lib/node_modules/$pkgname
	local extpkgs="vscode-json-languageservice $(_get_yarn_deps vscode-json-languageservice)"

	install -d "$moddir"/node_modules
	install -m 0644 dist/server.js "$moddir"/
	for p in $extpkgs; do
		cp -r node_modules/$p "$moddir"/node_modules/
	done

	install -Dm0755 "$srcdir"/$pkgname "$pkgdir"/usr/bin/$pkgname
	install -Dm0644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}
sha512sums="
a109290edb5034610b88aff07bce9c5b40ac0838c8bb509454bdfa23e14b68b4f7fa283b7fcf99083adf617df68c4337b8a4d9ddb586c2bcae7430cb18531605  yaml-language-server-1.19.0.tar.gz
a2040e537f2cace289cc1b983da219c9efc65ee7e287cd0863017d8274f3257cb429177e1d3e351a90c4b18b2d3c10e20a185d0f357056700562a7b28ace504f  yaml-language-server
"
