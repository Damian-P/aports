From d29d34cb97ef536e2db94354a7fa17ca4fe70f2c Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Wed, 28 May 2025 21:19:19 +0200
Subject: [PATCH] init: add support for setting a filter for autdetect_serial

ref: https://gitlab.alpinelinux.org/alpine/mkinitfs/-/merge_requests/196
---
 initramfs-init.in         | 14 +++++++++----
 mkinitfs-bootparam.7.in   | 12 +++++++----
 tests/initramfs-init.test | 42 ++++++++++++++++++++++++++++++++++++++-
 3 files changed, 59 insertions(+), 9 deletions(-)

diff --git a/initramfs-init.in b/initramfs-init.in
index 31c0f9f..9ec596a 100755
--- a/initramfs-init.in
+++ b/initramfs-init.in
@@ -143,9 +143,14 @@ setup_inittab_console() {
 
 setconsole_serial() {
 	for tty in $(detect_serial_consoles); do
-		if $MOCK setconsole /dev/$tty; then
+		if [ $# -eq 0 ] && $MOCK setconsole /dev/$tty; then
 			return
 		fi
+		for pattern in "$@"; do
+			if grep -E -q "$pattern" "$ROOT/sys/class/dmi/id/modalias" 2>/dev/null; then
+				$MOCK setconsole /dev/$tty && return
+			fi
+		done
 	done
 }
 
@@ -564,9 +569,10 @@ for opt; do
 	done
 done
 
-if [ "$KOPT_autodetect_serial" = "setconsole" ]; then
-	setconsole_serial
-fi
+case "$KOPT_autodetect_serial" in
+	setconsole) setconsole_serial;;
+	setconsole=*) setconsole_serial $(echo "${KOPT_autodetect_serial#setconsole=}" | tr ',' ' ');;
+esac
 
 echo "Alpine Init $VERSION" > "$ROOT"/dev/kmsg
 [ "$KOPT_quiet" = yes ] || echo "Alpine Init $VERSION"
diff --git a/mkinitfs-bootparam.7.in b/mkinitfs-bootparam.7.in
index bfd42f7..c0028b1 100644
--- a/mkinitfs-bootparam.7.in
+++ b/mkinitfs-bootparam.7.in
@@ -145,10 +145,14 @@ A HTTP, HTTPS or FTP URL to an apkovl.tar.gz file which will be retrieved and
 applied. Can also be a filesystem path, optionally prepended with the device
 name with the /dev/ prefix.
 .TP
-\fBautodetect_serial=\fR(\fIno\fR | \fIsetconsole\fR)
-If set to \fIno\fR, disable automatic detection and setup of serial console.
-If set to \fIsetconsole\fR, the console will be set to first detected serial
-console early during boot.
+\fBautodetect_serial=\fR(\fIno\fR | \fIsetconsole\fR | \fIsetconsole=REGEX{,REGEX,...}\fR)
+Configure serial console detection and setup.
+If set to \fIno\fR, automatic detection and setup of serial consoles is disabled.
+If set to \fIsetconsole\fR, the first detected serial console is set as the
+system console early during boot. If set to \fIsetconsole=REGEX{,REGEX,...}\fR,
+the same behavior applies, but \fIsetconsole\fR is only invoked if any of the
+provided regular expressions match the content of
+\fI/sys/class/dmi/id/modalias\fR.
 .TP
 \fBds=\fIOPTIONS\fR
 Data source for tiny-cloud. If \fIOPTIONS\fR starts with \fBnocloud\fR,
diff --git a/tests/initramfs-init.test b/tests/initramfs-init.test
index 304b8b9..49c06af 100755
--- a/tests/initramfs-init.test
+++ b/tests/initramfs-init.test
@@ -31,7 +31,9 @@ init_tests \
 	initramfs_init_wireguard \
 	initramfs_init_resume_offset \
 	initramfs_init_mount_usr \
-	initramfs_init_autodetect_serial_setconsole
+	initramfs_init_autodetect_serial_setconsole \
+	initramfs_init_autodetect_serial_setconsole_dmi_notfound \
+	initramfs_init_autodetect_serial_setconsole_dmi_match
 
 fake_cmdline() {
 	mkdir -p proc
@@ -541,3 +543,41 @@ initramfs_init_autodetect_serial_setconsole_body() {
 		-o match:"setconsole /dev/ttyS0" \
 		initramfs-init
 }
+
+initramfs_init_autodetect_serial_setconsole_dmi_notfound_body() {
+	fake_cmdline "root=/dev/vda1 autodetect_serial=setconsole=notfound"
+	fake_switch_root
+	fake_sysroot_init
+	fake_serial_devices
+	fake_bin stty <<-EOF
+		#!/bin/sh
+		true
+	EOF
+	mkdir -p sys/class/dmi/id
+	cat > sys/class/dmi/id/modalias <<-EOF
+		dmi:bvnEDKII:bvredk2-stable202408-prebuilt.qemu.org:bd08/13/2024:br0.0:svnQEMU:pnQEMUVirtualMachine:pvrvirt-10.0:cvnQEMU:ct1:cvrvirt-10.0:sku:
+	EOF
+
+	atf_check \
+		-o not-match:"setconsole /dev/ttyS0" \
+		initramfs-init
+}
+
+initramfs_init_autodetect_serial_setconsole_dmi_match_body() {
+	fake_cmdline "root=/dev/vda1 autodetect_serial=setconsole=notfound,pnQEMUVirtualMachine"
+	fake_switch_root
+	fake_sysroot_init
+	fake_serial_devices
+	fake_bin stty <<-EOF
+		#!/bin/sh
+		true
+	EOF
+	mkdir -p sys/class/dmi/id
+	cat > sys/class/dmi/id/modalias <<-EOF
+		dmi:bvnEDKII:bvredk2-stable202408-prebuilt.qemu.org:bd08/13/2024:br0.0:svnQEMU:pnQEMUVirtualMachine:pvrvirt-10.0:cvnQEMU:ct1:cvrvirt-10.0:sku:
+	EOF
+
+	atf_check \
+		-o match:"setconsole /dev/ttyS0" \
+		initramfs-init
+}
-- 
2.49.0

